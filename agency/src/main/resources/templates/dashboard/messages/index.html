<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{dashboard/layout}">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Messages</title>
    <link  href="/dashboard/css/messages.css" rel="stylesheet">

    <!-- WebSocket libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">



    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">


            <!-- Begin Page Content -->
            <div layout:fragment="content" class="container-fluid">

                <div class="chat-container">

                    <div class="main-content">
                        <div class="chat-display" id="chat-display">
                            <!-- Messages will be displayed here -->
                        </div>

                        <div class="input-area">
                            <input type="text" id="messageInput" class="message-input" placeholder="Mesajınızı yazın...">
                            <input type="hidden" id="senderId" value="admin">
                            <input type="hidden" id="senderName" value="Admin">
                            <input type="hidden" id="recipientId" value="">
                            <button class="send-button" id="sendButton" type="button">SEND</button>
                        </div>
                    </div>

                    <div class="sidebar">
                        <h3>Users</h3>
                        <ul id="userList">
                            <!-- Users will be loaded here -->


                        </ul>
                    </div>

                </div>

                <script th:inline="javascript">
                    let stompClient = null;
                    let currentRecipientId = null;

                    // Connect to WebSocket
                    function connect() {
                        const socket = new SockJS('/ws');
                        stompClient = Stomp.over(socket);

                        stompClient.connect({}, function(frame) {
                            console.log('Connected: ' + frame);

                            // Subscribe to receive messages
                            const senderId = document.getElementById('senderId').value; // This is the admin's ID
                            stompClient.subscribe('/user/' + senderId + '/queue/messages', function(message) {
                                console.log('Received message:', message.body);
                                const chatMessage = JSON.parse(message.body);
                                const adminId = document.getElementById('senderId').value;

                                // If the message is for the admin
                                if (chatMessage.recipientId === adminId) {
                                    showMessage(chatMessage, false); // Always display message for the admin

                                    // If the message is from a user not currently selected, refresh the user list
                                    if (chatMessage.senderId !== currentRecipientId) {
                                        loadChatUsers(); // Refresh user list to potentially highlight new message
                                    }
                                }
                            });

                            // Subscribe to notifications
                            stompClient.subscribe('/user/' + senderId + '/queue/notifications', function(notification) {
                                console.log('Received notification:', notification.body);
                            });
                        }, function(error) {
                            console.log('WebSocket connection error: ' + error);
                            setTimeout(connect, 5000); // Reconnect after 5 seconds
                        });
                    }

                    // Send message
                    function sendMessage() {
                        const messageInput = document.getElementById('messageInput');
                        const messageContent = messageInput.value.trim();

                        if (messageContent && stompClient && currentRecipientId) {
                            const chatMessage = {
                                senderId: document.getElementById('senderId').value,
                                senderName: document.getElementById('senderName').value,
                                recipientId: currentRecipientId,
                                content: messageContent,
                                timestamp: new Date()
                            };

                            stompClient.send("/app/chat", {}, JSON.stringify(chatMessage));

                            // Display sent message
                            showMessage(chatMessage, true);

                            // Clear input
                            messageInput.value = '';
                        } else if (!currentRecipientId) {
                            alert('Zəhmət olmasa istifadəçi seçin!');
                        }
                    }

                    // Display message in chat
                    function showMessage(message, isSent) {
                        const chatDisplay = document.getElementById('chat-display');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = isSent ? 'message sent' : 'message received';
                        messageDiv.textContent = message.content;
                        chatDisplay.appendChild(messageDiv);

                        // Scroll to bottom
                        chatDisplay.scrollTop = chatDisplay.scrollHeight;
                    }

                    // Select user to chat with
                    function selectUser(userId, userName) {
                        currentRecipientId = userId;
                        document.getElementById('recipientId').value = userId;

                        // Clear chat display
                        document.getElementById('chat-display').innerHTML = '';

                        // Load chat history
                        loadChatHistory(document.getElementById('senderId').value, userId);

                        // Highlight selected user
                        document.querySelectorAll('#userList li').forEach(li => {
                            li.style.backgroundColor = '';
                        });
                        event.target.style.backgroundColor = '#e0e0e0';
                    }

                    // Load chat history
                    function loadChatHistory(senderId, recipientId) {
                        fetch(`/messages/${senderId}/${recipientId}`)
                            .then(response => response.json())
                            .then(messages => {
                                messages.forEach(message => {
                                    showMessage(message, message.senderId === senderId);
                                });
                            })
                            .catch(error => console.error('Error loading chat history:', error));
                    }

                    // Event listeners
                    document.getElementById('sendButton').addEventListener('click', sendMessage);
                    document.getElementById('messageInput').addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            sendMessage();
                        }
                    });

                    function loadChatUsers() {
                        const adminId = document.getElementById('senderId').value; // Should be 'admin'
                        fetch(`/chat/users/${adminId}`)
                            .then(response => response.json())
                            .then(userIds => {
                                const userList = document.getElementById('userList');
                                userList.innerHTML = ''; // Clear existing static users
                                userIds.forEach(userId => {
                                    const li = document.createElement('li');
                                    li.textContent = userId; // Display the user ID, or fetch user details if available
                                    li.style.cursor = 'pointer';
                                    li.onclick = function() { selectUser(userId, userId); }; // Using userId as userName for now
                                    userList.appendChild(li);
                                });

                                // Automatically select the first user if available
                                if (userIds.length > 0) {
                                    selectUser(userIds[0], userIds[0]);
                                    // Highlight the first user in the list visually
                                    if (userList.firstElementChild) {
                                        userList.firstElementChild.style.backgroundColor = '#e0e0e0';
                                    }
                                }
                            })
                            .catch(error => console.error('Error loading chat users:', error));
                    }

                    // Connect on page load
                    connect();
                    loadChatUsers();
                </script>

            </div>


        </div>
        <!-- End of Main Content -->



    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

</body>

</html>